<!--<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Registration</title>
</head>
<body>
    <h1>Student Registration Form</h1>
    <form id="registration-form">
        <label for="full-name">Full Name:</label><br>
        <input type="text" id="full-name" name="full_name" required><br><br>

        <label for="email">Email:</label><br>
        <input type="email" id="email" name="email" required><br><br>

        <label for="phone">Phone:</label><br>
        <input type="tel" id="phone" name="phone"><br><br>

        <label for="dob">Date of Birth:</label><br>
        <input type="date" id="dob" name="date_of_birth" required><br><br>

        <button type="submit">Register</button>
    </form>
    <p id="message"></p>

    <script>
        document.getElementById('registration-form').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission

            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            fetch('http://127.0.0.1:8000/api/students/', { // Adjust API URL as needed
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                const messageElement = document.getElementById('message');
                if (response.ok) {
                    messageElement.textContent = 'Registration successful!';
                    messageElement.style.color = 'green';
                    form.reset(); // Clear the form
                } else {
                    return response.json().then(errorData => {
                        throw new Error(JSON.stringify(errorData));
                    });
                }
            })
            .catch(error => {
                const messageElement = document.getElementById('message');
                messageElement.textContent = `Registration failed: ${error.message}`;
                messageElement.style.color = 'red';
            });
        });
    </script>
</body>
</html>-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management</title>
</head>
<body>
    <h1>Student Management System</h1>

    <div id="form-container">
        <h2>Add a New Student</h2>
        <form id="student-form">
            <label for="full-name">Full Name:</label><br>
            <input type="text" id="full-name" name="full_name" required><br><br>

            <label for="email">Email:</label><br>
            <input type="email" id="email" name="email" required><br><br>

            <label for="phone">Phone:</label><br>
            <input type="tel" id="phone" name="phone"><br><br>

            <label for="dob">Date of Birth:</label><br>
            <input type="date" id="dob" name="date_of_birth" required><br><br>

            <button type="submit" id="submit-button">Add Student</button>
        </form>
    </div>

    <div id="list-container">
        <h2>Registered Students</h2>
        <p id="loading-message">Loading students...</p>
        <ul id="students-list"></ul>
    </div>
    
    <p id="message" style="margin-top: 20px;"></p>

    <script>
        const studentForm = document.getElementById('student-form');
        const submitButton = document.getElementById('submit-button');
        const studentsList = document.getElementById('students-list');
        const messageElement = document.getElementById('message');
        const loadingMessage = document.getElementById('loading-message');

        let isUpdateMode = false;
        let studentIdToUpdate = null;

        // Base API URL
        const API_URL = 'http://127.0.0.1:8000/api/students/';

        // --- RETRIEVE (Read) All Students ---
        async function fetchStudents() {
            loadingMessage.style.display = 'block';
            studentsList.innerHTML = '';
            try {
                const response = await fetch(API_URL);
                const students = await response.json();
                
                loadingMessage.style.display = 'none';

                if (students.length === 0) {
                    studentsList.innerHTML = '<p>No students registered yet.</p>';
                    return;
                }

                students.forEach(student => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <strong>Name:</strong> ${student.full_name}, 
                        <strong>Email:</strong> ${student.email}
                        <button onclick="populateFormForUpdate(${student.id})">Edit</button>
                        <button onclick="deleteStudent(${student.id})">Delete</button>
                    `;
                    studentsList.appendChild(listItem);
                });
            } catch (error) {
                loadingMessage.textContent = 'Failed to load students. Please try again.';
                console.error('Fetch error:', error);
            }
        }

        // --- CREATE (Post) & UPDATE (Put) Student ---
        studentForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const formData = new FormData(studentForm);
            const data = Object.fromEntries(formData.entries());

            try {
                let response;
                if (isUpdateMode) {
                    // This is an UPDATE request (PUT)
                    response = await fetch(`${API_URL}${studentIdToUpdate}/`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    // This is a CREATE request (POST)
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    messageElement.textContent = isUpdateMode ? 'Student updated successfully!' : 'Registration successful!';
                    messageElement.style.color = 'green';
                    studentForm.reset();
                    isUpdateMode = false;
                    studentIdToUpdate = null;
                    submitButton.textContent = 'Add Student';
                    fetchStudents(); // Refresh the list
                } else {
                    const errorData = await response.json();
                    throw new Error(JSON.stringify(errorData));
                }
            } catch (error) {
                messageElement.textContent = `Operation failed: ${error.message}`;
                messageElement.style.color = 'red';
            }
        });

        // --- DELETE a Student ---
        async function deleteStudent(studentId) {
            if (confirm('Are you sure you want to delete this student?')) {
                try {
                    const response = await fetch(`${API_URL}${studentId}/`, {
                        method: 'DELETE',
                    });
                    if (response.ok) {
                        messageElement.textContent = 'Student deleted successfully!';
                        messageElement.style.color = 'green';
                        fetchStudents(); // Refresh the list
                    } else {
                        const errorData = await response.json();
                        throw new Error(JSON.stringify(errorData));
                    }
                } catch (error) {
                    messageElement.textContent = `Deletion failed: ${error.message}`;
                    messageElement.style.color = 'red';
                }
            }
        }

        // Helper function to load student data into the form for editing
        async function populateFormForUpdate(studentId) {
            try {
                const response = await fetch(`${API_URL}${studentId}/`);
                const student = await response.json();
                
                document.getElementById('full-name').value = student.full_name;
                document.getElementById('email').value = student.email;
                document.getElementById('phone').value = student.phone;
                document.getElementById('dob').value = student.date_of_birth;

                isUpdateMode = true;
                studentIdToUpdate = studentId;
                submitButton.textContent = 'Update Student';
                
                messageElement.textContent = `Editing student: ${student.full_name}`;
                messageElement.style.color = 'black';
            } catch (error) {
                messageElement.textContent = 'Failed to load student data for editing.';
                messageElement.style.color = 'red';
            }
        }

        // Call fetchStudents() on page load to display the initial list
        window.onload = fetchStudents;
    </script>
</body>
</html>